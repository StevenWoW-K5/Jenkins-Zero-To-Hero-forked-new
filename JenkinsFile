pipeline {
  agent {
    docker {
      image 'abhishekf5/maven-abhishek-docker-agent:v1'
      args '--user root -v /var/run/docker.sock:/var/run/docker.sock' // mount Docker socket to access the host's Docker daemon
    }
  }

      //options {
          //skipDefaultCheckout() // Skip the default checkout step in Declarative Pipelines
      //}
  stages {

              stage('Update Deployment File') {
                  environment {
                      GIT_REPO_NAME = "Jenkins-Zero-To-Hero-forked"
                      GIT_USER_NAME = "StevenWoW-K5"
                  }
                  steps {
                      //withCredentials([string(credentialsId: 'github', variable: 'GITHUB_TOKEN')]) {
                          //def oldPath = 'image: rockuk/ultimate-cicd:[\w.-]+'
                          //def newPath = 'image: rockuk/ultimate-cicd:${BUILD_NUMBER}'
                      script {
                          def oldPath = "image: rockuk/ultimate-cicd:[\\w.-]+"
                          def newPath = "image: rockuk/ultimate-cicd:${BUILD_NUMBER}"
                          sh 'pwd'
                          sh 'ls -ltr -a'
                          checkout changelog: false, poll: false, scm: scmGit(branches: [[name: '*/main']], extensions: [], userRemoteConfigs: [[credentialsId: '8c0b4de7-ab96-4d0e-9eec-a561ee4a5b6e', url: 'git@github.com:StevenWoW-K5/Jenkins-Zero-To-Hero-forked-Deployment.git']])
                          sh 'pwd'
                          sh 'ls -ltr -a'
                          sh '''
                              git config user.email "stevenwu@163.com"
                              git config user.name "StevenWoW-K5"
                              BUILD_NUMBER=${BUILD_NUMBER}
                              ls -ltr

                              cat spring-boot-app-manifests/deployment.yml
                              echo "hello"

                              sed -i -E "s/image: rockuk\\/ultimate-cicd:([a-zA-Z0-9.]+)/image: rockuk\\/ultimate-cicd:${BUILD_NUMBER}/g" "spring-boot-app-manifests/deployment.yml"
                              cat spring-boot-app-manifests/deployment.yml
                              git add spring-boot-app-manifests/deployment.yml
                              git commit -m "Update deployment image to version ${BUILD_NUMBER}"
                              //git push https://${GITHUB_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME} HEAD:main

                              git remote -v

                              git push origin HEAD:main

                          '''
                          //git push https://${GITHUB_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME} HEAD:main
                          }
                      //}

                  }
              }
      }
}
